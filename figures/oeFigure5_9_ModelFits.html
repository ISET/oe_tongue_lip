<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,IE=9,chrome=1"><meta name="generator" content="MATLAB 2024b"><title>Model fits to tongue and lip (Figures 5-9)</title><style type="text/css">.rtcContent { padding: 30px; } .S0 { margin: 3px 10px 5px 4px; padding: 0px; line-height: 28.8px; min-height: 0px; white-space: pre-wrap; color: rgb(192, 76, 11); font-family: Helvetica, Arial, sans-serif, Helvetica, Arial, sans-serif; font-style: normal; font-size: 24px; font-weight: 400; text-align: left;  }
.S1 { margin: 2px 10px 9px 4px; padding: 0px; line-height: 24px; min-height: 0px; white-space: pre-wrap; color: rgb(33, 33, 33); font-family: Helvetica, Arial, sans-serif, Helvetica, Arial, sans-serif; font-style: normal; font-size: 16px; font-weight: 400; text-align: left;  }
.S2 { margin: 20px 10px 5px 4px; padding: 0px; line-height: 25px; min-height: 0px; white-space: pre-wrap; color: rgb(33, 33, 33); font-family: Helvetica, Arial, sans-serif, Helvetica, Arial, sans-serif; font-style: normal; font-size: 20px; font-weight: 700; text-align: left;  }
.S3 { margin: 10px 0px 20px; padding-left: 0px; font-family: Helvetica, Arial, sans-serif, Helvetica, Arial, sans-serif; font-size: 16px;  }
.S4 { margin-left: 64px; line-height: 24px; min-height: 0px; text-align: left; white-space: pre-wrap;  }
.S5 { margin: 3px 10px 5px 4px; padding: 0px; line-height: 25px; min-height: 0px; white-space: pre-wrap; color: rgb(33, 33, 33); font-family: Helvetica, Arial, sans-serif, Helvetica, Arial, sans-serif; font-style: normal; font-size: 20px; font-weight: 700; text-align: left;  }
.CodeBlock { background-color: #F5F5F5; margin: 10px 15px 10px 0; display: inline-block }
.S6 { border-left: 0.994318px solid rgb(217, 217, 217); border-right: 0.994318px solid rgb(217, 217, 217); border-top: 0.994318px solid rgb(217, 217, 217); border-bottom: 0px none rgb(33, 33, 33); border-radius: 4px 4px 0px 0px; padding: 6px 45px 0px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace, Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S7 { border-left: 0.994318px solid rgb(217, 217, 217); border-right: 0.994318px solid rgb(217, 217, 217); border-top: 0px none rgb(33, 33, 33); border-bottom: 0px none rgb(33, 33, 33); border-radius: 0px; padding: 0px 45px 0px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace, Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S8 { border-left: 0.994318px solid rgb(217, 217, 217); border-right: 0.994318px solid rgb(217, 217, 217); border-top: 0px none rgb(33, 33, 33); border-bottom: 0.994318px solid rgb(217, 217, 217); border-radius: 0px 0px 4px 4px; padding: 0px 45px 4px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace, Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.eoOutputWrapper { width: calc(90vw - 10px) !important; }
.S9 { border-left: 0.994318px solid rgb(217, 217, 217); border-right: 0.994318px solid rgb(217, 217, 217); border-top: 0px none rgb(33, 33, 33); border-bottom: 0.994318px solid rgb(217, 217, 217); border-radius: 0px; padding: 0px 45px 4px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace, Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S10 { color: rgb(33, 33, 33); padding: 10px 0px 6px 17px; background: rgb(255, 255, 255) none repeat scroll 0% 0% / auto padding-box border-box; font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px; overflow-x: hidden; line-height: 17.234px;  }
/* Styling that is common to warnings and errors is in diagnosticOutput.css */.embeddedOutputsErrorElement {    min-height: 18px;    max-height: 550px;}
.embeddedOutputsErrorElement .diagnosticMessage-errorType {    overflow: auto;}
.embeddedOutputsErrorElement.activeOutput .eoOutputContent {    user-select: text;    -webkit-user-select: text;}
.embeddedOutputsErrorElement.activeOutput .eoOutputContent button {    user-select: none;    -webkit-user-select: none;}
.embeddedOutputsErrorElement .eoOutputContent ::selection {}
.embeddedOutputsErrorElement.inlineElement {}
.embeddedOutputsErrorElement.rightPaneElement {}
/* Styling that is common to warnings and errors is in diagnosticOutput.css */.embeddedOutputsWarningElement {    min-height: 18px;    max-height: 550px;}
.embeddedOutputsWarningElement .diagnosticMessage-warningType {    overflow: auto;}
.embeddedOutputsWarningElement.activeOutput .eoOutputContent {    user-select: text;    -webkit-user-select: text;}
.embeddedOutputsWarningElement .eoOutputContent ::selection {}
.embeddedOutputsWarningElement.inlineElement {}
.embeddedOutputsWarningElement.rightPaneElement {}
/* Copyright 2015-2023 The MathWorks, Inc. *//* In this file, styles are not scoped to rtcContainer since they could be in the Dojo Tooltip */.diagnosticMessage-wrapper {    font-family: Menlo, Monaco, Consolas, "Courier New", monospace;    font-size: 12px;}
.diagnosticMessage-wrapper.diagnosticMessage-warningType {    /*This fallback value will be used for appdesigner warnings*/    color: var(--rtc-warning-output-color, var(--mw-color-matlabWarning));}
.diagnosticMessage-wrapper.diagnosticMessage-warningType a {    /*This fallback value will be used for appdesigner warnings*/    color: var(--rtc-warning-output-color, var(--mw-color-matlabWarning));    text-decoration: underline;}
.rtcThemeDefaultOverride .diagnosticMessage-wrapper.diagnosticMessage-warningType,.rtcThemeDefaultOverride .diagnosticMessage-wrapper.diagnosticMessage-warningType a {    color: var(--mw-color-matlabWarning) !important;}
.diagnosticMessage-wrapper.diagnosticMessage-errorType {    /*This fallback value will be used in appdesigner error tooltip text*/    color: var(--rtc-error-output-color, var(--mw-color-matlabErrors));}
.diagnosticMessage-wrapper.diagnosticMessage-errorType a {    /*This fallback value will be used in appdesigner error tooltip text*/    color: var(--rtc-error-output-color, var(--mw-color-matlabErrors));    text-decoration: underline;}
.rtcThemeDefaultOverride .diagnosticMessage-wrapper.diagnosticMessage-errorType,.rtcThemeDefaultOverride .diagnosticMessage-wrapper.diagnosticMessage-errorType a {    color: var(--mw-color-matlabErrors) !important;}
.diagnosticMessage-wrapper .diagnosticMessage-messagePart,.diagnosticMessage-wrapper .diagnosticMessage-causePart {    white-space: pre-wrap;}
.diagnosticMessage-wrapper .diagnosticMessage-stackPart {    white-space: pre;}
.embeddedOutputsTextElement,.embeddedOutputsVariableStringElement {    white-space: pre;    word-wrap:  initial;    min-height: 18px;    max-height: 550px;}
.embeddedOutputsTextElement .textElement,.embeddedOutputsVariableStringElement .textElement {    overflow: auto;}
.embeddedOutputsTextElement.activeOutput .eoOutputContent,.embeddedOutputsVariableStringElement.activeOutput .eoOutputContent {    user-select: text;    -webkit-user-select: text;}
/*embeddedOutputsTextElement has a different dom structure than embeddedOutputsVariableStringElement.Unlike variableString, the text output has both TEXT nodes and elements as children. Hence we needa selector for each.*/.embeddedOutputsTextElement .eoOutputContent::selection,.embeddedOutputsTextElement .eoOutputContent ::selection,.embeddedOutputsVariableStringElement .eoOutputContent ::selection {}
.textElement,.rtcDataTipElement .textElement {    padding-top: 2px;}
.embeddedOutputsTextElement.inlineElement,.embeddedOutputsVariableStringElement.inlineElement {}
.inlineElement .textElement {}
.embeddedOutputsTextElement.rightPaneElement,.embeddedOutputsVariableStringElement.rightPaneElement {    min-height: 16px;}
.rightPaneElement .textElement {    padding-top: 2px;    padding-left: 9px;}
.S11 { margin: 10px 10px 9px 4px; padding: 0px; line-height: 24px; min-height: 0px; white-space: pre-wrap; color: rgb(33, 33, 33); font-family: Helvetica, Arial, sans-serif, Helvetica, Arial, sans-serif; font-style: normal; font-size: 16px; font-weight: 400; text-align: left;  }
.S12 { border-left: 0.994318px solid rgb(217, 217, 217); border-right: 0.994318px solid rgb(217, 217, 217); border-top: 0.994318px solid rgb(217, 217, 217); border-bottom: 0.994318px solid rgb(217, 217, 217); border-radius: 4px; padding: 6px 45px 4px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace, Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S13 { margin: 15px 10px 5px 4px; padding: 0px; line-height: 18px; min-height: 0px; white-space: pre-wrap; color: rgb(33, 33, 33); font-family: Helvetica, Arial, sans-serif, Helvetica, Arial, sans-serif; font-style: normal; font-size: 17px; font-weight: 700; text-align: left;  }</style></head><body><div class = rtcContent><h1  class = 'S0'><span>Model fits to tongue and lip (Figures 5-9)</span></h1><div  class = 'S1'><span style=' font-weight: bold;'>Repository dependencies:  </span><span>ISETCam, isetfluorescence</span></div><div  class = 'S1'><span>This script creates the individual fits of the model in Figures 5-9.  It also creates the data for Tables 1 and 2.</span></div><h2  class = 'S2'><span>Stage 1 (oeSolveJoint).</span></h2><div  class = 'S1'><span>We fix a matrix with collagen1-smooth, FAD_webfluor, porphyrin and chlorophyll excitations. We choose these four because the first two fit the lip data well.  This guarantees that we will be able to find a fit to the lip data at the end.</span></div><div  class = 'S1'><span>We use oeSolveJoint to do two things.  </span></div><ol  class = 'S3'><li  class = 'S4'><span>Vary the blood oxygen of collagen, and </span></li><li  class = 'S4'><span>Search for one more, additional fluorophore, specified only as a skewed Gaussian with three parameters (mean, width, skew), to improve the fit. </span></li></ol><div  class = 'S1'><span>The additional (fifth) fluorophore is a stand-in for keratin, which is present on the tongue, but not on the lip.  We call this estimated fluorophore pseudo-keratin.</span></div><div  class = 'S1'><span>In the initial stage of the fit, we use the same blood density for all subjects.  The purpose of this stage is to learn about the parameters of the skewed Gaussian, which we store and use later.</span></div><h2  class = 'S2'><span>Stage 2 (oeSolveBlood)</span></h2><div  class = 'S1'><span>We confirm that we can fit the lip data with just the collagen and FAD, searching for blood.  This is for the group lipData.</span></div><h2  class = 'S2'><span>Stage 3 (oeSolveBlood)</span></h2><div  class = 'S1'><span>We loop through the subjects.  </span></div><div  class = 'S1'><span>For the tongue, we use the five fluorophores (collagen, FAD, porphyrin, chlorophyll, pseudo-keratin) and solve for the blood in each subject.</span></div><div  class = 'S1'><span>For the lip, we use only two fluorophores (collagen, FAD) and solve for the blood in each subject.</span></div><h2  class = 'S5'><span>Initialize script-wide parameters</span></h2><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >ieInit;</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >wave = 500:700;</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >normWave = 520;</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >yscale = </span><span style="color: #a709f5;">'linear'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >odLevels = 1:1:40;</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >fise_plotDefaults;</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >subjects = oeSubjects;</span></span></div></div><div class="inlineWrapper"><div  class = 'S8'><span style="white-space: pre"><span >[T,dataDir] = oeDatabaseCreate;</span></span></div></div></div><h2  class = 'S5'><span>Load the  tongue data in the two excitation wavelength grups</span></h2><div  class = 'S1'><span>Here, we load all of the subjects into a single large data set for tongue. In this case we group the 405 and 415 nm excitation lights.  We put the tongue and lip data, normalized at nWave, on the same graph.  We fit these to find the pseudo-keratin.</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >tongueData = [];</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span style="color: #0e00ff;">for </span><span >ii=1:numel(subjects)</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    files405 = ieTableGet(T,</span><span style="color: #a709f5;">'subject'</span><span >,subjects{ii},</span><span style="color: #a709f5;">'substrate'</span><span >,</span><span style="color: #a709f5;">'tongue'</span><span >,</span><span style="color: #a709f5;">'e wave'</span><span >,405);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    files415 = ieTableGet(T,</span><span style="color: #a709f5;">'subject'</span><span >,subjects{ii},</span><span style="color: #a709f5;">'substrate'</span><span >,</span><span style="color: #a709f5;">'tongue'</span><span >,</span><span style="color: #a709f5;">'e wave'</span><span >,415);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    tongueFiles = cat(1,files405,files415);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    tmp  = oeReadFiles(tongueFiles,</span><span style="color: #a709f5;">'normalized wave'</span><span >,normWave,</span><span style="color: #a709f5;">'wave'</span><span >,wave);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    tongueData = cat(2,tongueData,tmp);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span style="color: #0e00ff;">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >tongueData450 = [];</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span style="color: #0e00ff;">for </span><span >ii=1:numel(subjects)</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    files450 = ieTableGet(T,</span><span style="color: #a709f5;">'subject'</span><span >,subjects{ii},</span><span style="color: #a709f5;">'substrate'</span><span >,</span><span style="color: #a709f5;">'tongue'</span><span >,</span><span style="color: #a709f5;">'e wave'</span><span >,450);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    tmp  = oeReadFiles(files450,</span><span style="color: #a709f5;">'normalized wave'</span><span >,normWave,</span><span style="color: #a709f5;">'wave'</span><span >,wave); </span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    tongueData450 = cat(2,tongueData450,tmp);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span style="color: #0e00ff;">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S8'>&nbsp;</div></div></div><h2  class = 'S5'><span>Load the fixed fluorophores</span></h2><div  class = 'S1'><span>These are stored in the isetfluorescence repository.  That is needed for this paper.</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >fluorophoreNamesB = {</span><span style="color: #a709f5;">'collagen1-smooth'</span><span >,</span><span style="color: #a709f5;">'FAD_webfluor'</span><span >,</span><span style="color: #a709f5;">'PorphyrinBjurshammar'</span><span >,</span><span style="color: #a709f5;">'chlorophyllA-7'</span><span >};</span></span></div></div><div class="inlineWrapper outputs"><div  class = 'S9'><span style="white-space: pre"><span >[fixedFluorophores,wave] = fiLoadBasis(fluorophoreNamesB,</span><span style="color: #a709f5;">'wave'</span><span >,wave);</span></span></div><div  class = 'S10'><div class="inlineElement eoOutputWrapper disableDefaultGestureHandling embeddedOutputsErrorElement" uid="00718ED0" prevent-scroll="true" data-testid="output_0" tabindex="-1" style="width: 952.026px; white-space: normal; font-style: normal; color: rgb(33, 33, 33); font-size: 12px;"><div class="diagnosticMessage-wrapper diagnosticMessage-errorType eoOutputContent" tabindex="-1" data-previous-available-width="915" data-previous-scroll-height="19" data-hashorizontaloverflow="false" role="article" aria-roledescription="Use Browse Mode to explore " aria-description="error output " style="max-height: 261px; white-space: normal; font-style: normal; color: rgb(183, 49, 44); font-size: 12px;"><div class="diagnosticMessage-messagePart" style="white-space: pre-wrap; font-style: normal; color: rgb(183, 49, 44); font-size: 12px;">Unrecognized function or variable 'fiLoadBasis'.</div><div class="diagnosticMessage-stackPart" style="white-space: pre; font-style: normal; color: rgb(183, 49, 44); font-size: 12px;"></div></div></div></div></div></div><h2  class = 'S5'><span>Call the joint search</span></h2><div  class = 'S1'><span>We have fluorophores for the lip that fit well if we adjust the blood density (per subject).  Those are collagen1-smooth and FAD_webfluor.  We fix those two fluorophores.  We also know the emission spectra of porphyrins and chlorophyll-a.  These four are contained in the fixedFluorophores variable.</span></div><div  class = 'S1'><span>Here, we estimate the emission spectrum of keratain, which we call pseudo-keratin. We do the fit by pooling the tongue data from all the subjects and searching for a mean blood optical density and an additional fluorophore (basis) that is modeled as a skewed Gaussian. oeSolveJoint returns four weights.  The first is the optical blood density.  The next three are the three parameters of the fitted skewedGaussian.  It also returns the skewedGaussian as a column in the finalFluorophores matrix.</span></div><div  class = 'S1'><span>The five columns of finalFluorophores are:  collagen1-smooth, FAD_webfluor, porphyrin, chlorophyll, pseudo-keratin/  </span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >[global_params, weights, finalFluorophores] = oeSolveJoint(wave, tongueData, fixedFluorophores);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >disp(global_params);</span></span></div></div><div class="inlineWrapper"><div  class = 'S8'><span style="white-space: pre"><span >od = global_params(1);</span></span></div></div></div><div  class = 'S11'><span>We will want these columns.  We keep them in savedFluorophores are the original fluorophores </span><span style=' font-weight: bold;'>without</span><span> blood and the newly estimated pseudo-keratin fluorophore. These are the fluorophores we use these later when we search for the blood density in individual subjects. When we solve for the finalFluorophores in each fit, it adjusts the savedFluorophores by putting the blood into the collagen-smooth column.  That's why we need to start the fits with the savedFluorophores.  The finalFluorophores have the blood attenuated collagen, which is fit to each subject.</span></div><div  class = 'S1'><span>Note:  When we fit the lip data, we do not use the last three fluorophores (porphyrins, chlorophyll-a, pseudo-keratin).  So the lipFluorophores are only blood attenuated collagen and FAD.</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S12'><span style="white-space: pre"><span >savedFluorophores = [fixedFluorophores,finalFluorophores(:,end)];</span></span></div></div></div><h2  class = 'S5'><span>Show the fluorophores and blood incorporated (Figure 5)</span></h2><div  class = 'S1'><span>The finalFluorophores have blood-attenuated collagen and pseudo-keratin.  We plot them scaled by the typical weight we find in the solution</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >weightedFluorophores = finalFluorophores*diag(mean(weights,2));</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >ieFigure; hold </span><span style="color: #a709f5;">on</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >symbols ={</span><span style="color: #a709f5;">'k-'</span><span >,</span><span style="color: #a709f5;">'k--'</span><span >,</span><span style="color: #a709f5;">'k--o'</span><span >,</span><span style="color: #a709f5;">'k--x'</span><span >,</span><span style="color: #a709f5;">'k:'</span><span >};</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span style="color: #0e00ff;">for </span><span >ii=1:size(weightedFluorophores,2)</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    plot(wave,weightedFluorophores(:,ii),symbols{ii},</span><span style="color: #a709f5;">'LineWidth'</span><span >,2); </span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span style="color: #0e00ff;">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >set(gca,</span><span style="color: #a709f5;">'Fontsize'</span><span >,24);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >grid </span><span style="color: #a709f5;">on</span><span >; xlabel(</span><span style="color: #a709f5;">'Wavelength (nm)'</span><span >,</span><span style="color: #a709f5;">'Fontsize'</span><span >,24); ylabel(</span><span style="color: #a709f5;">'Relative emission'</span><span >,</span><span style="color: #a709f5;">'Fontsize'</span><span >,24);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >lgn = legend(</span><span style="color: #a709f5;">'collagen-blood'</span><span >,</span><span style="color: #a709f5;">'FAD'</span><span >,</span><span style="color: #a709f5;">'porphyrin'</span><span >,</span><span style="color: #a709f5;">'chlorophyll'</span><span >,</span><span style="color: #a709f5;">'pseudo-keratin'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >fname = fullfile(oeTongueLipRootPath,</span><span style="color: #a709f5;">'figures'</span><span >,</span><span style="color: #a709f5;">'Figure5B.svg'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >print(gcf,fname,</span><span style="color: #a709f5;">'-dsvg'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S8'><span style="white-space: pre"><span style="color: #008013;">% exportgraphics(gcf,'figure5B.png','Resolution',150)</span></span></div></div></div><h2  class = 'S5'><span>Load the lip data</span></h2><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >lipData = [];</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span style="color: #0e00ff;">for </span><span >ii=1:numel(subjects)</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    files405 = ieTableGet(T,</span><span style="color: #a709f5;">'subject'</span><span >,subjects{ii},</span><span style="color: #a709f5;">'substrate'</span><span >,</span><span style="color: #a709f5;">'lip'</span><span >,</span><span style="color: #a709f5;">'e wave'</span><span >,405);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    files415 = ieTableGet(T,</span><span style="color: #a709f5;">'subject'</span><span >,subjects{ii},</span><span style="color: #a709f5;">'substrate'</span><span >,</span><span style="color: #a709f5;">'lip'</span><span >,</span><span style="color: #a709f5;">'e wave'</span><span >,415);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    lipFiles = cat(1,files405,files415);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    tmp  = oeReadFiles(lipFiles,</span><span style="color: #a709f5;">'normalized wave'</span><span >,normWave,</span><span style="color: #a709f5;">'wave'</span><span >,wave);   </span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    lipData = cat(2,lipData,tmp);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span style="color: #0e00ff;">end </span></span></div></div><div class="inlineWrapper"><div  class = 'S7'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >lipData450 = [];</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span style="color: #0e00ff;">for </span><span >ii=1:numel(subjects)</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    files450 = ieTableGet(T,</span><span style="color: #a709f5;">'subject'</span><span >,subjects{ii},</span><span style="color: #a709f5;">'substrate'</span><span >,</span><span style="color: #a709f5;">'lip'</span><span >,</span><span style="color: #a709f5;">'e wave'</span><span >,450);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    tmp  = oeReadFiles(files450,</span><span style="color: #a709f5;">'normalized wave'</span><span >,normWave,</span><span style="color: #a709f5;">'wave'</span><span >,wave);       </span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    lipData450 = cat(2,lipData450,tmp);</span></span></div></div><div class="inlineWrapper"><div  class = 'S8'><span style="white-space: pre"><span style="color: #0e00ff;">end </span></span></div></div></div><h2  class = 'S5'><span>Fit the subjects individually (Figure 6)</span></h2><div  class = 'S1'><span>For each subject, the tongue data with 405 and 415.  Use the five fluorophores to fit, adjusting only for the blood.</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >odTongue = zeros(1,numel(subjects));</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >weights = cell(4,1);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >nTongue = zeros(1,numel(subjects));</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >ieFigure;</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >tiledlayout(2,2);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span style="color: #0e00ff;">for </span><span >ii=1:numel(subjects)   </span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    </span><span style="color: #008013;">% Load the tongue data</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    files405 = ieTableGet(T,</span><span style="color: #a709f5;">'subject'</span><span >,subjects{ii},</span><span style="color: #a709f5;">'substrate'</span><span >,</span><span style="color: #a709f5;">'tongue'</span><span >,</span><span style="color: #a709f5;">'e wave'</span><span >,405);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    files415 = ieTableGet(T,</span><span style="color: #a709f5;">'subject'</span><span >,subjects{ii},</span><span style="color: #a709f5;">'substrate'</span><span >,</span><span style="color: #a709f5;">'tongue'</span><span >,</span><span style="color: #a709f5;">'e wave'</span><span >,415);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    tongueFiles = cat(1,files405,files415);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    tongueData  = oeReadFiles(tongueFiles,</span><span style="color: #a709f5;">'normalized wave'</span><span >,normWave,</span><span style="color: #a709f5;">'wave'</span><span >,wave);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    nTongue(ii) = size(tongueData,2);    </span></span></div></div><div class="inlineWrapper"><div  class = 'S7'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    </span><span style="color: #008013;">% Find the blood optical density</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    [odTongue(ii),weights{ii},finalFluorophores] = oeSolveBlood(wave,tongueData,savedFluorophores);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    predicted = finalFluorophores*weights{ii};</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    nexttile;</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    plot(wave,predicted,</span><span style="color: #a709f5;">'k--'</span><span >,</span><span style="color: #a709f5;">'LineWidth'</span><span >,2); hold </span><span style="color: #a709f5;">on</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    plot(wave,tongueData,</span><span style="color: #a709f5;">'Color'</span><span >,[1 1 1]*0.7,</span><span style="color: #a709f5;">'LineWidth'</span><span >,2); grid </span><span style="color: #a709f5;">on</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    xlabel(</span><span style="color: #a709f5;">'Wavelength (nm)'</span><span >); ylabel(</span><span style="color: #a709f5;">'Normalized radiance'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    set(gca,</span><span style="color: #a709f5;">'ylim'</span><span >,[0 1.6]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    </span><span style="color: #0e00ff;">if </span><span >ii==4, set(gca,</span><span style="color: #a709f5;">'ylim'</span><span >,[0 3]); </span><span style="color: #0e00ff;">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    title(sprintf(</span><span style="color: #a709f5;">'Subject %d:  rmse %.3f'</span><span >,ii,rmse(tongueData(:),predicted(:))));</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span style="color: #0e00ff;">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >fname = fullfile(oeTongueLipRootPath,</span><span style="color: #a709f5;">'figures'</span><span >,</span><span style="color: #a709f5;">'Figure6.svg'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >print(gcf,fname,</span><span style="color: #a709f5;">'-dsvg'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S8'><span style="white-space: pre"><span style="color: #008013;">% exportgraphics(gcf,'figure6.png','Resolution',150);</span></span></div></div></div><h2  class = 'S5'><span>Table of the tongue weights and blood od</span></h2><div  class = 'S1'><span>Print the mean of the weights and the standard deviation</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >fluorophoreNames = [</span><span style="color: #a709f5;">"Collagen"</span><span >, </span><span style="color: #a709f5;">"FAD"</span><span >,  </span><span style="color: #a709f5;">"Porphyrin"</span><span >, </span><span style="color: #a709f5;">"Chlorophyll-a" "Keratin"</span><span >];</span></span></div></div><div class="inlineWrapper"><div  class = 'S8'><span style="white-space: pre"><span >oePrintModel(fluorophoreNames,odTongue,weights,nTongue);</span></span></div></div></div><h2  class = 'S5'><span>Fit the lip data to each individual (Figure 7)</span></h2><div  class = 'S1'><span>For the lip, we only fit using the collagen and FAD data, adjusting for the blood.  We omit the porphyrins, chlorophyll and pseudo-keratin.</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >fluorophoreNamesLip = [</span><span style="color: #a709f5;">"Collagen"</span><span >, </span><span style="color: #a709f5;">"FAD"</span><span >];</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >odLip = zeros(1,numel(subjects));</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >nLip = zeros(1,numel(subjects));</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >weights = cell(4,1);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >ieFigure;</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >tiledlayout(2,2);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span style="color: #0e00ff;">for </span><span >ii=1:numel(subjects)   </span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    </span><span style="color: #008013;">% Load the lip data</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    files405 = ieTableGet(T,</span><span style="color: #a709f5;">'subject'</span><span >,subjects{ii},</span><span style="color: #a709f5;">'substrate'</span><span >,</span><span style="color: #a709f5;">'lip'</span><span >,</span><span style="color: #a709f5;">'e wave'</span><span >,405);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    files415 = ieTableGet(T,</span><span style="color: #a709f5;">'subject'</span><span >,subjects{ii},</span><span style="color: #a709f5;">'substrate'</span><span >,</span><span style="color: #a709f5;">'lip'</span><span >,</span><span style="color: #a709f5;">'e wave'</span><span >,415);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    lipFiles = cat(1,files405,files415);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    lipData  = oeReadFiles(lipFiles,</span><span style="color: #a709f5;">'normalized wave'</span><span >,normWave,</span><span style="color: #a709f5;">'wave'</span><span >,wave);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    nLip(ii) = size(lipData,2);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    </span><span style="color: #008013;">% Find the blood optical density using only the first two columns of</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    </span><span style="color: #008013;">% saved fluorophores.</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    [odLip(ii),weights{ii},finalFluorophores] = oeSolveBlood(wave,lipData,savedFluorophores(:,[1,2]));</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    predicted = finalFluorophores*weights{ii};</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    nexttile;</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    plot(wave,predicted,</span><span style="color: #a709f5;">'k--'</span><span >,</span><span style="color: #a709f5;">'LineWidth'</span><span >,2); hold </span><span style="color: #a709f5;">on</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    plot(wave,lipData,</span><span style="color: #a709f5;">'Color'</span><span >,[1 1 1]*0.7,</span><span style="color: #a709f5;">'LineWidth'</span><span >,2); grid </span><span style="color: #a709f5;">on</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    xlabel(</span><span style="color: #a709f5;">'Wavelength (nm)'</span><span >); ylabel(</span><span style="color: #a709f5;">'Normalized radiance'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    set(gca,</span><span style="color: #a709f5;">'ylim'</span><span >,[0 1.5]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    title(sprintf(</span><span style="color: #a709f5;">'Subject %d:  rmse %.3f'</span><span >,ii,rmse(lipData(:),predicted(:))));</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span style="color: #0e00ff;">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >fname = fullfile(oeTongueLipRootPath,</span><span style="color: #a709f5;">'figures'</span><span >,</span><span style="color: #a709f5;">'Figure7.svg'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >print(gcf,fname,</span><span style="color: #a709f5;">'-dsvg'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S8'><span style="white-space: pre"><span style="color: #008013;">% exportgraphics(gcf,'figure7.png','Resolution',150);</span></span></div></div></div><h3  class = 'S13'><span>Table of the lip weights and blood density</span></h3><div  class = 'S1'><span>405 nm and 415 nm</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S12'><span style="white-space: pre"><span >oePrintModel(fluorophoreNamesLip,odLip,weights,nLip);</span></span></div></div></div><h2  class = 'S5'><span>Fit individually again, different excitation light (Figure 8)</span></h2><div  class = 'S1'><span>Now with the 450 nm excitation</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >odTongue = zeros(1,numel(subjects));</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >nTongue450 = zeros(1,numel(subjects));</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >weights = cell(4,1);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >ieFigure;</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >tiledlayout(2,2);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span style="color: #0e00ff;">for </span><span >ii=1:numel(subjects)   </span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    </span><span style="color: #008013;">% Load the tongue data</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    tongueFiles450 = ieTableGet(T,</span><span style="color: #a709f5;">'subject'</span><span >,subjects{ii},</span><span style="color: #a709f5;">'substrate'</span><span >,</span><span style="color: #a709f5;">'tongue'</span><span >,</span><span style="color: #a709f5;">'e wave'</span><span >,450);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    tongueData  = oeReadFiles(tongueFiles450,</span><span style="color: #a709f5;">'normalized wave'</span><span >,normWave,</span><span style="color: #a709f5;">'wave'</span><span >,wave);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    nTongue450(ii) = size(tongueData,2);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    </span><span style="color: #008013;">% Find the blood optical density</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    [odTongue(ii),weights{ii},finalFluorophores] = oeSolveBlood(wave,tongueData,savedFluorophores);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    predicted = finalFluorophores*weights{ii};</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    nexttile;</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    plot(wave,predicted,</span><span style="color: #a709f5;">'k--'</span><span >,</span><span style="color: #a709f5;">'LineWidth'</span><span >,2); hold </span><span style="color: #a709f5;">on</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    plot(wave,tongueData,</span><span style="color: #a709f5;">'Color'</span><span >,[1 1 1]*0.7,</span><span style="color: #a709f5;">'LineWidth'</span><span >,2); grid </span><span style="color: #a709f5;">on</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    xlabel(</span><span style="color: #a709f5;">'Wavelength (nm)'</span><span >); ylabel(</span><span style="color: #a709f5;">'Normalized radiance'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    set(gca,</span><span style="color: #a709f5;">'ylim'</span><span >,[0 1.6]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    </span><span style="color: #0e00ff;">if </span><span >ii==4, set(gca,</span><span style="color: #a709f5;">'ylim'</span><span >,[0 3]); </span><span style="color: #0e00ff;">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    title(sprintf(</span><span style="color: #a709f5;">'Subject %d:  rmse %.3f'</span><span >,ii,rmse(tongueData(:),predicted(:))));</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span style="color: #0e00ff;">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >fname = fullfile(oeTongueLipRootPath,</span><span style="color: #a709f5;">'figures'</span><span >,</span><span style="color: #a709f5;">'Figure8.svg'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >print(gcf,fname,</span><span style="color: #a709f5;">'-dsvg'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S8'><span style="white-space: pre"><span style="color: #008013;">% exportgraphics(gcf,'figure8.png','Resolution',150);</span></span></div></div></div><h3  class = 'S13'><span>Here is the 450 nm table</span></h3><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S12'><span style="white-space: pre"><span >oePrintModel(fluorophoreNames,odTongue,weights,nTongue450);</span></span></div></div></div><h2  class = 'S5'><span>Lip with the 450 nm excitation light (Figure 9)</span></h2><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >odLip = zeros(1,numel(subjects));</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >weights = cell(4,1);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >nLip450 = zeros(1,numel(subjects));</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >ieFigure;</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >tiledlayout(2,2);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span style="color: #0e00ff;">for </span><span >ii=1:numel(subjects)   </span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    </span><span style="color: #008013;">% Load the lip data</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    lipFiles450 = ieTableGet(T,</span><span style="color: #a709f5;">'subject'</span><span >,subjects{ii},</span><span style="color: #a709f5;">'substrate'</span><span >,</span><span style="color: #a709f5;">'lip'</span><span >,</span><span style="color: #a709f5;">'e wave'</span><span >,450);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    lipData  = oeReadFiles(lipFiles450,</span><span style="color: #a709f5;">'normalized wave'</span><span >,normWave,</span><span style="color: #a709f5;">'wave'</span><span >,wave);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    nLip450(ii) = size(lipData,2);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    </span><span style="color: #008013;">% Find the blood optical density using only the first two columns of</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    </span><span style="color: #008013;">% saved fluorophores.</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    [odLip(ii),weights{ii},finalFluorophores] = oeSolveBlood(wave,lipData,savedFluorophores(:,[1,2]));</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    predicted = finalFluorophores*weights{ii};</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    nexttile;</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    plot(wave,predicted,</span><span style="color: #a709f5;">'k--'</span><span >,</span><span style="color: #a709f5;">'LineWidth'</span><span >,2); hold </span><span style="color: #a709f5;">on</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    plot(wave,lipData,</span><span style="color: #a709f5;">'Color'</span><span >,[1 1 1]*0.7,</span><span style="color: #a709f5;">'LineWidth'</span><span >,2); grid </span><span style="color: #a709f5;">on</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    xlabel(</span><span style="color: #a709f5;">'Wavelength (nm)'</span><span >); ylabel(</span><span style="color: #a709f5;">'Normalized radiance'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    set(gca,</span><span style="color: #a709f5;">'ylim'</span><span >,[0 1.5]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    title(sprintf(</span><span style="color: #a709f5;">'Subject %d:  rmse %.3f'</span><span >,ii,rmse(lipData(:),predicted(:))));</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span style="color: #0e00ff;">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >fname = fullfile(oeTongueLipRootPath,</span><span style="color: #a709f5;">'figures'</span><span >,</span><span style="color: #a709f5;">'Figure9.svg'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >print(gcf,fname,</span><span style="color: #a709f5;">'-dsvg'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S8'><span style="white-space: pre"><span style="color: #008013;">% exportgraphics(gcf,'figure9.png','Resolution',150);</span></span></div></div></div><h3  class = 'S13'><span>Table for 450 nm excitation.</span></h3><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >fluorophoreNames = [</span><span style="color: #a709f5;">"Collagen"</span><span >, </span><span style="color: #a709f5;">"FAD"</span><span >];</span></span></div></div><div class="inlineWrapper"><div  class = 'S8'><span style="white-space: pre"><span >oePrintModel(fluorophoreNamesLip,odLip,weights,nLip450);</span></span></div></div></div>
<br>
<!-- 
##### SOURCE BEGIN #####
%% Model fits to tongue and lip (Figures 5-9)
% *Repository dependencies:*  ISETCam, isetfluorescence
% 
% This script creates the individual fits of the model in Figures 5-9.  It also 
% creates the data for Tables 1 and 2.
%% Stage 1 (oeSolveJoint).
% We fix a matrix with collagen1-smooth, FAD_webfluor, porphyrin and chlorophyll 
% excitations. We choose these four because the first two fit the lip data well.  
% This guarantees that we will be able to find a fit to the lip data at the end.
% 
% We use oeSolveJoint to do two things.  
%% 
% # Vary the blood oxygen of collagen, and 
% # Search for one more, additional fluorophore, specified only as a skewed 
% Gaussian with three parameters (mean, width, skew), to improve the fit. 
%% 
% The additional (fifth) fluorophore is a stand-in for keratin, which is present 
% on the tongue, but not on the lip.  We call this estimated fluorophore pseudo-keratin.
% 
% In the initial stage of the fit, we use the same blood density for all subjects.  
% The purpose of this stage is to learn about the parameters of the skewed Gaussian, 
% which we store and use later.
%% Stage 2 (oeSolveBlood)
% We confirm that we can fit the lip data with just the collagen and FAD, searching 
% for blood.  This is for the group lipData.
%% Stage 3 (oeSolveBlood)
% We loop through the subjects.  
% 
% For the tongue, we use the five fluorophores (collagen, FAD, porphyrin, chlorophyll, 
% pseudo-keratin) and solve for the blood in each subject.
% 
% For the lip, we use only two fluorophores (collagen, FAD) and solve for the 
% blood in each subject.
%% Initialize script-wide parameters

ieInit;
wave = 500:700;
normWave = 520;
yscale = 'linear';
odLevels = 1:1:40;
fise_plotDefaults;
subjects = oeSubjects;
[T,dataDir] = oeDatabaseCreate;
%% Load the  tongue data in the two excitation wavelength grups
% Here, we load all of the subjects into a single large data set for tongue. 
% In this case we group the 405 and 415 nm excitation lights.  We put the tongue 
% and lip data, normalized at nWave, on the same graph.  We fit these to find 
% the pseudo-keratin.

tongueData = [];
for ii=1:numel(subjects)
    files405 = ieTableGet(T,'subject',subjects{ii},'substrate','tongue','e wave',405);
    files415 = ieTableGet(T,'subject',subjects{ii},'substrate','tongue','e wave',415);
    tongueFiles = cat(1,files405,files415);
    tmp  = oeReadFiles(tongueFiles,'normalized wave',normWave,'wave',wave);
    tongueData = cat(2,tongueData,tmp);
end

tongueData450 = [];
for ii=1:numel(subjects)
    files450 = ieTableGet(T,'subject',subjects{ii},'substrate','tongue','e wave',450);
    tmp  = oeReadFiles(files450,'normalized wave',normWave,'wave',wave); 
    tongueData450 = cat(2,tongueData450,tmp);
end

%% Load the fixed fluorophores
% These are stored in the isetfluorescence repository.  That is needed for this 
% paper.

fluorophoreNamesB = {'collagen1-smooth','FAD_webfluor','PorphyrinBjurshammar','chlorophyllA-7'};
[fixedFluorophores,wave] = fiLoadBasis(fluorophoreNamesB,'wave',wave);
%% Call the joint search
% We have fluorophores for the lip that fit well if we adjust the blood density 
% (per subject).  Those are collagen1-smooth and FAD_webfluor.  We fix those two 
% fluorophores.  We also know the emission spectra of porphyrins and chlorophyll-a.  
% These four are contained in the fixedFluorophores variable.
% 
% Here, we estimate the emission spectrum of keratain, which we call pseudo-keratin. 
% We do the fit by pooling the tongue data from all the subjects and searching 
% for a mean blood optical density and an additional fluorophore (basis) that 
% is modeled as a skewed Gaussian. oeSolveJoint returns four weights.  The first 
% is the optical blood density.  The next three are the three parameters of the 
% fitted skewedGaussian.  It also returns the skewedGaussian as a column in the 
% finalFluorophores matrix.
% 
% The five columns of finalFluorophores are:  collagen1-smooth, FAD_webfluor, 
% porphyrin, chlorophyll, pseudo-keratin/  

[global_params, weights, finalFluorophores] = oeSolveJoint(wave, tongueData, fixedFluorophores);
disp(global_params);
od = global_params(1);
%% 
% We will want these columns.  We keep them in savedFluorophores are the original 
% fluorophores *without* blood and the newly estimated pseudo-keratin fluorophore. 
% These are the fluorophores we use these later when we search for the blood density 
% in individual subjects. When we solve for the finalFluorophores in each fit, 
% it adjusts the savedFluorophores by putting the blood into the collagen-smooth 
% column.  That's why we need to start the fits with the savedFluorophores.  The 
% finalFluorophores have the blood attenuated collagen, which is fit to each subject.
% 
% Note:  When we fit the lip data, we do not use the last three fluorophores 
% (porphyrins, chlorophyll-a, pseudo-keratin).  So the lipFluorophores are only 
% blood attenuated collagen and FAD.

savedFluorophores = [fixedFluorophores,finalFluorophores(:,end)];
%% Show the fluorophores and blood incorporated (Figure 5)
% The finalFluorophores have blood-attenuated collagen and pseudo-keratin.  
% We plot them scaled by the typical weight we find in the solution

weightedFluorophores = finalFluorophores*diag(mean(weights,2));

ieFigure; hold on;
symbols ={'k-','kREPLACE_WITH_DASH_DASH','kREPLACE_WITH_DASH_DASHo','kREPLACE_WITH_DASH_DASHx','k:'};
for ii=1:size(weightedFluorophores,2)
    plot(wave,weightedFluorophores(:,ii),symbols{ii},'LineWidth',2); 
end

set(gca,'Fontsize',24);
grid on; xlabel('Wavelength (nm)','Fontsize',24); ylabel('Relative emission','Fontsize',24);
lgn = legend('collagen-blood','FAD','porphyrin','chlorophyll','pseudo-keratin');
fname = fullfile(oeTongueLipRootPath,'figures','Figure5B.svg');
print(gcf,fname,'-dsvg');
% exportgraphics(gcf,'figure5B.png','Resolution',150)
%% Load the lip data

lipData = [];
for ii=1:numel(subjects)
    files405 = ieTableGet(T,'subject',subjects{ii},'substrate','lip','e wave',405);
    files415 = ieTableGet(T,'subject',subjects{ii},'substrate','lip','e wave',415);
    lipFiles = cat(1,files405,files415);
    tmp  = oeReadFiles(lipFiles,'normalized wave',normWave,'wave',wave);   
    lipData = cat(2,lipData,tmp);
end 

lipData450 = [];
for ii=1:numel(subjects)
    files450 = ieTableGet(T,'subject',subjects{ii},'substrate','lip','e wave',450);
    tmp  = oeReadFiles(files450,'normalized wave',normWave,'wave',wave);       
    lipData450 = cat(2,lipData450,tmp);
end 
%% Fit the subjects individually (Figure 6)
% For each subject, the tongue data with 405 and 415.  Use the five fluorophores 
% to fit, adjusting only for the blood.

odTongue = zeros(1,numel(subjects));
weights = cell(4,1);
nTongue = zeros(1,numel(subjects));
ieFigure;
tiledlayout(2,2);
for ii=1:numel(subjects)   
    % Load the tongue data
    files405 = ieTableGet(T,'subject',subjects{ii},'substrate','tongue','e wave',405);
    files415 = ieTableGet(T,'subject',subjects{ii},'substrate','tongue','e wave',415);
    tongueFiles = cat(1,files405,files415);
    tongueData  = oeReadFiles(tongueFiles,'normalized wave',normWave,'wave',wave);
    nTongue(ii) = size(tongueData,2);    

    % Find the blood optical density
    [odTongue(ii),weights{ii},finalFluorophores] = oeSolveBlood(wave,tongueData,savedFluorophores);
    predicted = finalFluorophores*weights{ii};
    nexttile;
    plot(wave,predicted,'kREPLACE_WITH_DASH_DASH','LineWidth',2); hold on;
    plot(wave,tongueData,'Color',[1 1 1]*0.7,'LineWidth',2); grid on;
    xlabel('Wavelength (nm)'); ylabel('Normalized radiance');
    set(gca,'ylim',[0 1.6]);
    if ii==4, set(gca,'ylim',[0 3]); end
    title(sprintf('Subject %d:  rmse %.3f',ii,rmse(tongueData(:),predicted(:))));
end
fname = fullfile(oeTongueLipRootPath,'figures','Figure6.svg');
print(gcf,fname,'-dsvg');
% exportgraphics(gcf,'figure6.png','Resolution',150);
%% Table of the tongue weights and blood od
% Print the mean of the weights and the standard deviation

fluorophoreNames = ["Collagen", "FAD",  "Porphyrin", "Chlorophyll-a" "Keratin"];
oePrintModel(fluorophoreNames,odTongue,weights,nTongue);
%% Fit the lip data to each individual (Figure 7)
% For the lip, we only fit using the collagen and FAD data, adjusting for the 
% blood.  We omit the porphyrins, chlorophyll and pseudo-keratin.

fluorophoreNamesLip = ["Collagen", "FAD"];

odLip = zeros(1,numel(subjects));
nLip = zeros(1,numel(subjects));
weights = cell(4,1);
ieFigure;
tiledlayout(2,2);
for ii=1:numel(subjects)   
    % Load the lip data
    files405 = ieTableGet(T,'subject',subjects{ii},'substrate','lip','e wave',405);
    files415 = ieTableGet(T,'subject',subjects{ii},'substrate','lip','e wave',415);
    lipFiles = cat(1,files405,files415);
    lipData  = oeReadFiles(lipFiles,'normalized wave',normWave,'wave',wave);
    nLip(ii) = size(lipData,2);

    % Find the blood optical density using only the first two columns of
    % saved fluorophores.
    [odLip(ii),weights{ii},finalFluorophores] = oeSolveBlood(wave,lipData,savedFluorophores(:,[1,2]));
    predicted = finalFluorophores*weights{ii};
    nexttile;
    plot(wave,predicted,'kREPLACE_WITH_DASH_DASH','LineWidth',2); hold on;
    plot(wave,lipData,'Color',[1 1 1]*0.7,'LineWidth',2); grid on;
    xlabel('Wavelength (nm)'); ylabel('Normalized radiance');
    set(gca,'ylim',[0 1.5]);
    title(sprintf('Subject %d:  rmse %.3f',ii,rmse(lipData(:),predicted(:))));
end
fname = fullfile(oeTongueLipRootPath,'figures','Figure7.svg');
print(gcf,fname,'-dsvg');
% exportgraphics(gcf,'figure7.png','Resolution',150);
% Table of the lip weights and blood density
% 405 nm and 415 nm

oePrintModel(fluorophoreNamesLip,odLip,weights,nLip);
%% Fit individually again, different excitation light (Figure 8)
% Now with the 450 nm excitation

odTongue = zeros(1,numel(subjects));
nTongue450 = zeros(1,numel(subjects));
weights = cell(4,1);
ieFigure;
tiledlayout(2,2);
for ii=1:numel(subjects)   
    % Load the tongue data
    tongueFiles450 = ieTableGet(T,'subject',subjects{ii},'substrate','tongue','e wave',450);
    tongueData  = oeReadFiles(tongueFiles450,'normalized wave',normWave,'wave',wave);
    nTongue450(ii) = size(tongueData,2);

    % Find the blood optical density
    [odTongue(ii),weights{ii},finalFluorophores] = oeSolveBlood(wave,tongueData,savedFluorophores);
    predicted = finalFluorophores*weights{ii};
    nexttile;
    plot(wave,predicted,'kREPLACE_WITH_DASH_DASH','LineWidth',2); hold on;
    plot(wave,tongueData,'Color',[1 1 1]*0.7,'LineWidth',2); grid on;
    xlabel('Wavelength (nm)'); ylabel('Normalized radiance');
    set(gca,'ylim',[0 1.6]);
    if ii==4, set(gca,'ylim',[0 3]); end
    title(sprintf('Subject %d:  rmse %.3f',ii,rmse(tongueData(:),predicted(:))));
end
fname = fullfile(oeTongueLipRootPath,'figures','Figure8.svg');
print(gcf,fname,'-dsvg');
% exportgraphics(gcf,'figure8.png','Resolution',150);
% Here is the 450 nm table

oePrintModel(fluorophoreNames,odTongue,weights,nTongue450);
%% Lip with the 450 nm excitation light (Figure 9)

odLip = zeros(1,numel(subjects));
weights = cell(4,1);
nLip450 = zeros(1,numel(subjects));

ieFigure;
tiledlayout(2,2);
for ii=1:numel(subjects)   
    % Load the lip data
    lipFiles450 = ieTableGet(T,'subject',subjects{ii},'substrate','lip','e wave',450);
    lipData  = oeReadFiles(lipFiles450,'normalized wave',normWave,'wave',wave);
    nLip450(ii) = size(lipData,2);

    % Find the blood optical density using only the first two columns of
    % saved fluorophores.
    [odLip(ii),weights{ii},finalFluorophores] = oeSolveBlood(wave,lipData,savedFluorophores(:,[1,2]));
    predicted = finalFluorophores*weights{ii};
    nexttile;
    plot(wave,predicted,'kREPLACE_WITH_DASH_DASH','LineWidth',2); hold on;
    plot(wave,lipData,'Color',[1 1 1]*0.7,'LineWidth',2); grid on;
    xlabel('Wavelength (nm)'); ylabel('Normalized radiance');
    set(gca,'ylim',[0 1.5]);
    title(sprintf('Subject %d:  rmse %.3f',ii,rmse(lipData(:),predicted(:))));
end
fname = fullfile(oeTongueLipRootPath,'figures','Figure9.svg');
print(gcf,fname,'-dsvg');
% exportgraphics(gcf,'figure9.png','Resolution',150);
% Table for 450 nm excitation.

fluorophoreNames = ["Collagen", "FAD"];
oePrintModel(fluorophoreNamesLip,odLip,weights,nLip450);
##### SOURCE END #####
-->
</div></body></html>